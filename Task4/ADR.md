## ADR — Передача актуальных депозитных ставок в кол‑центры

---

### **Название задачи:**

Передача ставок во внутренний и партнёрский кол‑центры для консультации клиентов

### **Автор:**

Калинов П.М.

### **Дата:**

03 мая 2025 г.

---

### **Функциональные требования (Use Cases)**

|     №    | Действующие лица / системы                         | Use Case                    | Пошаговое описание                                                                                                                  |
| :------: | -------------------------------------------------- | --------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| **UC‑1** | Сотрудник бэк‑офиса депозитов → **АБС**            | Загрузить / изменить ставки | 1. В UI АБС загружает XLS.<br>2. PL/SQL‑пакет *Rates Pkg* валидирует файл.<br>3. Данные сохраняются в таблицу `DEPOSIT_RATES`.      |
| **UC‑2** | **Система кол‑центра банка** → **Deposit‑Gateway** | Получить ставки             | 1. Каждые 5 мин выполняет `GET /rates` (HTTPS, JSON).<br>2. Отображает ставки оператору для ответа клиенту.                         |
| **UC‑3** | **Deposit‑Gateway** → **SFTP‑сервер**              | Экспортировать CSV          | 1. Пакет‑джоб раз в час извлекает ставки из кэша.<br>2. Формирует `rates_YYYYMMDD_HH.csv`.<br>3. Кладёт файл в каталог `/outgoing`. |
| **UC‑4** | **Система партнёрского CC** → SFTP                 | Забрать файл ставок         | 1. По расписанию выполняет SFTP‑pull из `/outgoing`.<br>2. Импортирует CSV в свою БД.                                               |
| **UC‑5** | Оператор партнёрского CC                           | Консультировать клиента     | В UI выбирает продукт → видит ставки из внутренней БД и сообщает клиенту.                                                           |

---

### **Нефункциональные / архитектурно‑значимые требования**

|     №    | Требование                                                                 |
| :------: | -------------------------------------------------------------------------- |
| **NF‑1** | Актуальность ставок, доступных операторам, ≤ 1 час.                        |
| **NF‑2** | Среднее время ответа `GET /rates` < 300 мс, 95‑й процентиль < 500 мс.      |
| **NF‑3** | Доступность Deposit‑Gateway и SFTP ≥ 99,5 % (внутренний SLA).              |
| **NF‑4** | Шифрование трафика: TLS 1.2+ (REST) и SFTP c авторизацией по ключу.        |
| **NF‑5** | Не увеличивать нагрузку на Oracle‑БД АБС — одна выборка ставок в час.      |
| **NF‑6** | Использовать утверждённые в банке стеки: Oracle 11g, MS SQL, .NET 6, Java. |

---

### **Решение**

#### Диаграмма контекста (C4‑Level 1)



**Комментарий к диаграмме:**

1. Источником правды о ставках остаётся АБС.
2. Gateway выступает фасадом: даёт REST для внутреннего CC и выгружает CSV на SFTP.
3. Партнёрский CC технически изолирован, поэтому получает ставки файлами.

---

#### Диаграмма контейнеров (C4‑Level 2)



**Комментарий к диаграмме:**

* Gateway Batch обращается в кэш, тем самым Oracle дергается лишь раз в час триггером PL/SQL → кэш (NF‑5).
* Система кол‑центра подписывается на `/rates`, кешируя ответ 5 мин; UI мгновенно показывает ставки оператору (NF‑2).
* CSV‑файл имеет унифицированный формат: код продукта, срок, ставка, валюта.

---

### **Альтернативы**

| Решение                        | Преимущества                                                 | Недостатки / Риски                                   |     Статус    |
| ------------------------------ | ------------------------------------------------------------ | ---------------------------------------------------- | :-----------: |
| Прямой REST из АБС в CC        | Минимум компонентов                                          | Высокая нагрузка на Oracle, 24/7 SLA для АБС         |       ✗       |
| Kafka events со ставками       | Асинхронно, легко расширить                                  | Требует Kafka‑кластера; Интернет-банк не поддерживает Kafka |       ✗       |
| **Gateway + Cache + CSV/SFTP** | Разгрузка БД, простая инфраструктура, совместимо с партнёром | Задержка до 1 ч, обслуживание SFTP                   | **✓ принято** |

**Основная логика выбора:** банки ограничены по изменениям в АБС; REST‑фасад и кэш снимают нагрузку, а CSV‑файл удовлетворяет внешнего партнёра, который не может делать вызовы API.

---

### **Недостатки / Ограничения / Риски**

* Задержка обновления ставок до 60 мин — не критично для депозитов, но нужно мониторить.
* SFTP‑сервер требует резервирования (SLA 99,5 %).
* Ошибочная загрузка XLS оператором может испортить ставки во всех каналах; нужна валидация и версия данных.

---

## Список крупных задач (эпиков) для планирования

| Система             | T‑№                                                          | Задача |
| ------------------- | ------------------------------------------------------------ | ------ |
| **АБС**             | **T1** PL/SQL пакет *Rates Pkg* (таблица + CRUD + валидация) |        |
|                     | **T2** (опция) REST‑обёртка к `Rates Pkg`                    |        |
| **Deposit‑Gateway** | **T3** REST‑API `/rates` (.NET 6, token‑auth, swagger)       |        |
|                     | **T4** Служба CSV‑экспорта + выгрузка в SFTP                 |        |
| **SFTP**            | **T5** Развёртывание HA‑SFTP, настройка ключей, мониторинг   |        |
| **Система CC**      | **T6** Изменения UI, кэш 5 мин, интеграция REST              |        |
| **Партнёрский CC**  | **T7** Импорт CSV, расписание загрузки                       |        |

---

*Дальнейшие шаги: возможен переход на Kafka‑events после апгрейда интернет‑банка и отказ от CSV/SFTP.*


